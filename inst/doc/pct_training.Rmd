---
title: "Propensity to Cycle Tool Training course"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{pct_training}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
bibliography: refs_training.bib
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r, eval=FALSE, echo=FALSE}
# get citations
refs = RefManageR::ReadZotero(group = "418217", .params = list(collection = "JFR868KJ", limit = 100))
refs2 = RefManageR::ReadBib("vignettes/refs.bib")
refs = c(refs, refs2)
citr::insert_citation(bib_file = "vignettes/refs_training.bib")
RefManageR::WriteBib(refs, "vignettes/refs_training.bib")
citr::tidy_bib_file(rmd_file = "vignettes/pct_training.Rmd", messy_bibliography = "vignettes/refs_training.bib")
```

# Introduction

This workshop will demonstrate how the PCT was built using the open source statistical programming language R, how the underlying data can be accessed from the command-line for reproducible analysis, and how the methods can be used to generate new scenarios of cycling uptake.

There will be 2 courses:

- In London on **Friday 21st June** 
- In Leeds on **Friday 2nd August** 

# Prerequisites

This is an advanced training course with specific pre-requisites.
Please only register if you:

- Have experience analysing geographic area and route data of the type used in the PCT
- Have experience using software for geographic data, including working knowledge of the statistical programming language R
- Can bring a laptop that has up-to-date versions of R, RStudio and the necessary R packages installed (see next section)

In addition, if you want to do routing on your computer: 

- Register for a CycleStreets.net API key from: https://www.cyclestreets.net/api/

If you are new to R this course may not be appropriate for you.
If you are an intermediate user, it may be worth brushing-up on your R skills, e.g. by taking a free online course such as that provided by [DataCamp](https://www.datacamp.com/courses/free-introduction-to-r) or by working through [Chapter 2 onwards of the open source book *Geocomputation with R*](https://geocompr.robinlovelace.net/spatial-class.html) (see reading list below for more transport-specific resources).

## Prior reading

In addition to computer hardware (a laptop) and software (an up-to-date R set-up and experience using R) pre-requisites, you should have read, or at least have working knowledge of the contents of, the following publications, all of which are freely available online:

- The original paper on the Propensity to Cycle Tool [@lovelace_propensity_2017]
- The transport chapter ([12](https://geocompr.robinlovelace.net/transport.html)) in the open source book [*Geocomputation with R*](https://geocompr.robinlovelace.net/)  [@lovelace_geocomputation_2019]
- The vignette that describes the pct R package, which can be found here: https://itsleeds.github.io/pct/articles/pct.html

## R packages

**To ensure your computer is ready for the course, please test that you can run the following lines of R code on your computer, resulting in the map shown below:**

```{r, eval=FALSE}
install.packages("remotes")
pkgs = c(
  "cyclestreets",
  "mapview",
  "pct",
  "sf",
  "stats19",
  "stplanr",
  "tidyverse",
  "devtools"
)
remotes::install_cran(pkgs)
# remotes::install_github("ITSLeeds/pct")
```

## Test code

To test your computer is ready to work with PCT data in R, try running the following commands.
It should result in the map below showing the % of short trips in West Yorkshire made by active modes.


```{r setup, out.width="100%", message=FALSE}
library(pct)
library(dplyr)   # in the tidyverse
library(leaflet) # installed alongside mapvew
zones_all = get_pct_zones("west-yorkshire")
lines_all = get_pct_lines("west-yorkshire")

# basic plot
plot(zones_all$geometry)
plot(lines_all$geometry[lines_all$all > 500], col = "red", add = TRUE)

# interactive plot
active = lines_all %>% 
  mutate(`Percent Active` = (bicycle + foot) / all * 100) %>% 
  filter(e_dist_km < 5)
pal = colorBin(palette = "RdYlBu", domain = active$`Percent Active`, bins = c(0, 2, 4, 10, 15, 20, 30, 40, 90))
leaflet(data = active) %>% 
  addProviderTiles(providers$OpenStreetMap.BlackAndWhite) %>% 
  addPolylines(color = ~pal(`Percent Active`), weight = active$all / 100) %>% 
  addLegend(pal = pal, values = ~`Percent Active`)
```

We can also use the data to explore entrenched car dependence, as follows:

```{r, out.width="100%"}
# car dependent desire lines
car_dependent = lines_all %>% 
  mutate(`Percent Drive` = (car_driver) / all * 100) %>% 
  filter(e_dist_km < 5)
pal = colorBin(palette = "RdYlBu", domain = car_dependent$`Percent Active`, bins = c(0, 20, 40, 60, 80, 100), reverse = TRUE)
leaflet(data = car_dependent) %>% 
  addProviderTiles(providers$OpenStreetMap.BlackAndWhite) %>% 
  addPolylines(color = ~pal(`Percent Drive`), weight = active$all / 100) %>% 
  addLegend(pal = pal, values = ~`Percent Drive`)
```

# Agenda

- 09:30 - 10:00: Arrival and set-up
- 10:00 - 11:00: Data and methods underlying the PCT
- 11:00 - 12:30: Getting and analysing PCT data
    - Comparing PCT results with existing road infrastructure
        - Getting data from the CyIPT
        - Identfying 'weak links'
        - Identify gaps in the network

Lunch break

- 13:30 - 15:30: Extending the PCT: minihack
    - Alternative scenarios of cycling uptake
        - A 'replace short car trips' scenario
    - New input data
        - Travel to stations
    - Other extensions of the PCT

Coffee break and presentation of results

- 16:00 - 16:30: Policy implementation
    - Building open source web applications
    - Community-building
    - User interface
    - Policy uptake

# References
