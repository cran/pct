<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />

<meta name="viewport" content="width=device-width, initial-scale=1" />

<meta name="author" content="Robin Lovelace and Layik Hama" />

<meta name="date" content="2023-02-16" />

<title>Introducing the pct package</title>

<script>// Pandoc 2.9 adds attributes on both header and div. We remove the former (to
// be compatible with the behavior of Pandoc < 2.8).
document.addEventListener('DOMContentLoaded', function(e) {
  var hs = document.querySelectorAll("div.section[class*='level'] > :first-child");
  var i, h, a;
  for (i = 0; i < hs.length; i++) {
    h = hs[i];
    if (!/^h[1-6]$/i.test(h.tagName)) continue;  // it should be a header h1-h6
    a = h.attributes;
    while (a.length > 0) h.removeAttribute(a[0].name);
  }
});
</script>

<style type="text/css">
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
span.underline{text-decoration: underline;}
div.column{display: inline-block; vertical-align: top; width: 50%;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
</style>



<style type="text/css">
code {
white-space: pre;
}
.sourceCode {
overflow: visible;
}
</style>
<style type="text/css" data-origin="pandoc">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
{ counter-reset: source-line 0; }
pre.numberSource code > span
{ position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
{ content: counter(source-line);
position: relative; left: -1em; text-align: right; vertical-align: baseline;
border: none; display: inline-block;
-webkit-touch-callout: none; -webkit-user-select: none;
-khtml-user-select: none; -moz-user-select: none;
-ms-user-select: none; user-select: none;
padding: 0 4px; width: 4em;
color: #aaaaaa;
}
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa; padding-left: 4px; }
div.sourceCode
{ }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } 
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.at { color: #7d9029; } 
code span.bn { color: #40a070; } 
code span.bu { color: #008000; } 
code span.cf { color: #007020; font-weight: bold; } 
code span.ch { color: #4070a0; } 
code span.cn { color: #880000; } 
code span.co { color: #60a0b0; font-style: italic; } 
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.do { color: #ba2121; font-style: italic; } 
code span.dt { color: #902000; } 
code span.dv { color: #40a070; } 
code span.er { color: #ff0000; font-weight: bold; } 
code span.ex { } 
code span.fl { color: #40a070; } 
code span.fu { color: #06287e; } 
code span.im { color: #008000; font-weight: bold; } 
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.kw { color: #007020; font-weight: bold; } 
code span.op { color: #666666; } 
code span.ot { color: #007020; } 
code span.pp { color: #bc7a00; } 
code span.sc { color: #4070a0; } 
code span.ss { color: #bb6688; } 
code span.st { color: #4070a0; } 
code span.va { color: #19177c; } 
code span.vs { color: #4070a0; } 
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } 
</style>
<script>
// apply pandoc div.sourceCode style to pre.sourceCode instead
(function() {
  var sheets = document.styleSheets;
  for (var i = 0; i < sheets.length; i++) {
    if (sheets[i].ownerNode.dataset["origin"] !== "pandoc") continue;
    try { var rules = sheets[i].cssRules; } catch (e) { continue; }
    var j = 0;
    while (j < rules.length) {
      var rule = rules[j];
      // check if there is a div.sourceCode rule
      if (rule.type !== rule.STYLE_RULE || rule.selectorText !== "div.sourceCode") {
        j++;
        continue;
      }
      var style = rule.style.cssText;
      // check if color or background-color is set
      if (rule.style.color === '' && rule.style.backgroundColor === '') {
        j++;
        continue;
      }
      // replace div.sourceCode by a pre.sourceCode rule
      sheets[i].deleteRule(j);
      sheets[i].insertRule('pre.sourceCode{' + style + '}', j);
    }
  }
})();
</script>



<style type="text/css">

div.csl-bib-body { }
div.csl-entry {
clear: both;
}
.hanging div.csl-entry {
margin-left:2em;
text-indent:-2em;
}
div.csl-left-margin {
min-width:2em;
float:left;
}
div.csl-right-inline {
margin-left:2em;
padding-left:1em;
}
div.csl-indent {
margin-left: 2em;
}
</style>

<style type="text/css">body {
background-color: #fff;
margin: 1em auto;
max-width: 700px;
overflow: visible;
padding-left: 2em;
padding-right: 2em;
font-family: "Open Sans", "Helvetica Neue", Helvetica, Arial, sans-serif;
font-size: 14px;
line-height: 1.35;
}
#TOC {
clear: both;
margin: 0 0 10px 10px;
padding: 4px;
width: 400px;
border: 1px solid #CCCCCC;
border-radius: 5px;
background-color: #f6f6f6;
font-size: 13px;
line-height: 1.3;
}
#TOC .toctitle {
font-weight: bold;
font-size: 15px;
margin-left: 5px;
}
#TOC ul {
padding-left: 40px;
margin-left: -1.5em;
margin-top: 5px;
margin-bottom: 5px;
}
#TOC ul ul {
margin-left: -2em;
}
#TOC li {
line-height: 16px;
}
table {
margin: 1em auto;
border-width: 1px;
border-color: #DDDDDD;
border-style: outset;
border-collapse: collapse;
}
table th {
border-width: 2px;
padding: 5px;
border-style: inset;
}
table td {
border-width: 1px;
border-style: inset;
line-height: 18px;
padding: 5px 5px;
}
table, table th, table td {
border-left-style: none;
border-right-style: none;
}
table thead, table tr.even {
background-color: #f7f7f7;
}
p {
margin: 0.5em 0;
}
blockquote {
background-color: #f6f6f6;
padding: 0.25em 0.75em;
}
hr {
border-style: solid;
border: none;
border-top: 1px solid #777;
margin: 28px 0;
}
dl {
margin-left: 0;
}
dl dd {
margin-bottom: 13px;
margin-left: 13px;
}
dl dt {
font-weight: bold;
}
ul {
margin-top: 0;
}
ul li {
list-style: circle outside;
}
ul ul {
margin-bottom: 0;
}
pre, code {
background-color: #f7f7f7;
border-radius: 3px;
color: #333;
white-space: pre-wrap; 
}
pre {
border-radius: 3px;
margin: 5px 0px 10px 0px;
padding: 10px;
}
pre:not([class]) {
background-color: #f7f7f7;
}
code {
font-family: Consolas, Monaco, 'Courier New', monospace;
font-size: 85%;
}
p > code, li > code {
padding: 2px 0px;
}
div.figure {
text-align: center;
}
img {
background-color: #FFFFFF;
padding: 2px;
border: 1px solid #DDDDDD;
border-radius: 3px;
border: 1px solid #CCCCCC;
margin: 0 5px;
}
h1 {
margin-top: 0;
font-size: 35px;
line-height: 40px;
}
h2 {
border-bottom: 4px solid #f7f7f7;
padding-top: 10px;
padding-bottom: 2px;
font-size: 145%;
}
h3 {
border-bottom: 2px solid #f7f7f7;
padding-top: 10px;
font-size: 120%;
}
h4 {
border-bottom: 1px solid #f7f7f7;
margin-left: 8px;
font-size: 105%;
}
h5, h6 {
border-bottom: 1px solid #ccc;
font-size: 105%;
}
a {
color: #0033dd;
text-decoration: none;
}
a:hover {
color: #6666ff; }
a:visited {
color: #800080; }
a:visited:hover {
color: #BB00BB; }
a[href^="http:"] {
text-decoration: underline; }
a[href^="https:"] {
text-decoration: underline; }

code > span.kw { color: #555; font-weight: bold; } 
code > span.dt { color: #902000; } 
code > span.dv { color: #40a070; } 
code > span.bn { color: #d14; } 
code > span.fl { color: #d14; } 
code > span.ch { color: #d14; } 
code > span.st { color: #d14; } 
code > span.co { color: #888888; font-style: italic; } 
code > span.ot { color: #007020; } 
code > span.al { color: #ff0000; font-weight: bold; } 
code > span.fu { color: #900; font-weight: bold; } 
code > span.er { color: #a61717; background-color: #e3d2d2; } 
</style>




</head>

<body>




<h1 class="title toc-ignore">Introducing the pct package</h1>
<h3 class="subtitle">Obtaining and reproducing data from the Propensity
to Cycle Tool (PCT)</h3>
<h4 class="author">Robin Lovelace and Layik Hama</h4>
<h4 class="date">2023-02-16</h4>



<p>Set <code>eval=TRUE</code> to run this code when knitting:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span>opts_chunk<span class="sc">$</span><span class="fu">set</span>(<span class="at">eval =</span> <span class="cn">FALSE</span>)</span></code></pre></div>
<div id="introduction" class="section level2">
<h2>Introduction</h2>
<p>The goal of the <code>pct</code> package is to increase the
accessibility and reproducibility of the outputs from the Propensity to
Cycle Tool (PCT), a research project and web application hosted at <a href="https://www.pct.bike/">www.pct.bike</a>. The tool is one of just
~300 <a href="https://www.data.gov.uk/dataset/731b25a8-0462-4a7d-aa3f-5a5d44ae26d2/historical-performance-platform">central
government websites</a> exempt from the requirement to transition to the
.gov.uk domain name, and is a recommended source of evidence in the
preparation of Local Walking and Cycling plans (LCWIPs), as outlined in
<a href="https://assets.publishing.service.gov.uk/government/uploads/system/uploads/attachment_data/file/607016/cycling-walking-infrastructure-technical-guidance.pdf">technical
guidance</a><span class="citation"><sup>1</sup></span>, supporting the
Cycling and Walking Infrastructure Strategy (<a href="https://www.gov.uk/government/publications/cycling-and-walking-investment-strategy">CWIS</a>),
an amendment of the <a href="https://www.legislation.gov.uk/ukpga/2015/7/contents/enacted">Infrastructure
Act</a> 2015. For an overview of the data provided by the PCT, clicking
on the previous link and trying it out is a great place to start. An
academic <a href="https://www.jtlu.org/index.php/jtlu/article/view/862">paper</a> on
the PCT provides detail on the motivations and methods underlying the
project<span class="citation"><sup>2</sup></span>.</p>
<p>Since work on the package began in 2015, for example during the ODI
Leeds Hack my Route <a href="https://datamillnorth.org/community/blog/hack-my-route-live-blog/">hackathon</a>
(see <a href="https://twitter.com/robinlovelace/status/611979463803432960">an
early prototype of the tool here</a>), the features and demand for the
PCT have evolved substantially. In early 2019, for example, the <a href="https://blog.pct.bike/2019/03/18/propensity-to-cycle-to-school-layer-deployed/">School
travel layer</a> was added to the main PCT site to provide evidence
nationwide on the potential benefits of scenarios of cycling uptake, and
where safe routes to school should be prioritised<span class="citation"><sup>3</sup></span>. In fact, a major aim of the PCT
was to enable people to extend the tool<span class="citation"><sup>2</sup></span>:</p>
<blockquote>
<p>We envision stakeholders in local government modifying scenarios for
their own purposes, and that academics in relevant fields may add new
features and develop new use cases of the PCT.</p>
</blockquote>
<p>Motivated by this vision of adaptable transport planning tools, this
introductory vignette demonstrates how the package works with an example
from the <a href="https://en.wikipedia.org/wiki/Isle_of_Wight">Isle of
Wight</a>, an island just off the southern coast of Britain, with a
population of ~140,000 people. Before demonstrating some of the
package’s key functions, it’s worth providing a little context.</p>
</div>
<div id="why-this-package" class="section level2">
<h2>Why this package?</h2>
<p>The Propensity to Cycle Tool was commissioned by the UK’s Department
for Transport to help planners and others prioritise investment and
policies to get people cycling, as outlined in the Government report <a href="https://www.gov.uk/government/publications/national-propensity-to-cycle-first-phase-development-study">National
propensity to cycle: full report with annexes</a><span class="citation"><sup>4</sup></span>. However, the academic team leading
the project had a wider sub-aim: of making transport evidence more
accessible, encouraging evidence-based transport policies, and
encouraging a more democratic transport planning process, and that means
open transport data and open source transport modelling tools<span class="citation"><sup>2</sup></span>.</p>
<p>The code base underlying the PCT is publicly available (see <a href="https://github.com/npct/">github.com/npct</a>). However, the code
hosted there is not easy to run or reproduce, which is where this
package comes in: it provides quick access to the data underlying the
PCT and enables some of the key results to be reproduced quickly. It was
developed primarily for educational purposes (including for upcoming PCT
training courses) but it may be useful for people to build on the the
methods, for example to create a scenario of cycling uptake in their
town/city/region.</p>
<p>In summary, if you want to know how PCT works, be able to reproduce
some of its results, and build scenarios of cycling uptake to inform
transport policies enabling cycling in cities worldwide, this package is
for you!</p>
</div>
<div id="installation" class="section level2">
<h2>Installation</h2>
<p>You can install the development version of the package as
follows:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>remotes<span class="sc">::</span><span class="fu">install_github</span>(<span class="st">&quot;ITSLeeds/pct&quot;</span>)</span></code></pre></div>
<!-- You can install the released version of pct from [CRAN](https://CRAN.R-project.org) with: -->
<!-- ``` r -->
<!-- install.packages("pct") -->
<!-- ``` -->
<p>Load the package as follows:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(pct)</span></code></pre></div>
<p>We will also use the following packages in this tutorial:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(sf)</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(stplanr)</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(leaflet)</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(pbapply)</span></code></pre></div>
</div>
<div id="get-pct-data" class="section level1">
<h1>Get PCT data</h1>
<p>From feedback, we hear that the use of the data is critical in
decision making. Therefore, one area where the package could be useful
is making the data “easily” available to be processed.</p>
<p>To download the data within www.pct.bike, we have added a suite of
functions:</p>
<ul>
<li><code>get_pct()</code></li>
<li><code>get_pct_rnet()</code></li>
<li><code>get_pct_zones()</code></li>
<li><code>get_pct_lines()</code></li>
<li><code>get_pct_centroids()</code></li>
<li><code>get_pct_routes_fast()</code></li>
<li><code>get_pct_routes_quiet()</code></li>
</ul>
<p>There are other <code>get_()</code> functions that get official data
underlying the PCT, as we will see in a later section. For now, let’s
see how the functions work. To get the centroids in Isle of Wight at the
lower-resolution (smaller files) MSOA level (LSOA level data is returned
by default or by replacing <code>msoa</code> with <code>lsoa</code> in
the code below) you would run:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>wight_centroids <span class="ot">=</span> <span class="fu">get_pct_centroids</span>(<span class="at">region =</span> <span class="st">&quot;isle-of-wight&quot;</span>, <span class="at">geography =</span> <span class="st">&quot;msoa&quot;</span>)</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>wight_zones <span class="ot">=</span> <span class="fu">get_pct_zones</span>(<span class="at">region =</span> <span class="st">&quot;isle-of-wight&quot;</span>, <span class="at">geography =</span> <span class="st">&quot;msoa&quot;</span>)</span></code></pre></div>
<p>Let’s verify that the data gave us what we would expect to see:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(wight_centroids[, <span class="st">&quot;bicycle&quot;</span>])</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(wight_zones[, <span class="st">&quot;bicycle&quot;</span>])</span></code></pre></div>
<p>The results are indeed as we would expect, with the centroid data
showing points and the zone data showing zones. The zones with higher
cycling levels are in the more densely populated south of the island, as
we would expect. Likewise, the following command downloads the desire
lines for the Isle of Wight:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>wight_lines_pct <span class="ot">=</span> <span class="fu">get_pct_lines</span>(<span class="at">region =</span> <span class="st">&quot;isle-of-wight&quot;</span>, <span class="at">geography =</span> <span class="st">&quot;msoa&quot;</span>)</span></code></pre></div>
<p>The rest of the <code>get_pct_</code> functions are similar to the
above two examples and download data from www.pct.bike.</p>
<p>However, the base of these functions is <code>get_pct()</code>, which
takes the following arguments:</p>
<ul>
<li><code>base_url = &quot;https://github.com/npct/pct-outputs-regional-R/raw/master&quot;</code>:
just in case if you wanted to download the data from a similar
server</li>
<li><code>purpose = &quot;commute&quot;</code>: soon there will be “schools” and
maybe other modes, but currently commute is the only option.</li>
<li><code>geography = &quot;msoa&quot;</code>: MSOA or LSOA</li>
<li><code>region = NULL</code>: regions within
<code>pct::pct_regions</code></li>
<li><code>layer = NULL</code>: one of <code>z</code> (zones),
<code>c</code> (centroids), <code>l</code> (desire lines),
<code>rf</code> (routes fast), <code>rq</code> (routes quiet) or
<code>rnet</code>.</li>
<li>even <code>extension = &quot;.Rds&quot;</code> as PCT data is available in
various formats. For the purpose of this package we have made the
default option of “Rds”.</li>
</ul>
</div>
<div id="comparing-downloaded-data-with-the-pct-web-app" class="section level1">
<h1>Comparing downloaded data with the PCT web app</h1>
<p>To compare the downloaded data with data in the PCT web app, we will
take a subset of the <code>wight_lines_pct</code> dataset. The top 30
travelled desire lines by number of commuters who use cycling as their
main mode is taken in the following code chunk. The reason for selecting
the top 30 will become apparent (the <code>wight_lines_30</code> object
is provided in the PCT package):</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>wight_lines_30 <span class="ot">=</span> wight_lines_pct <span class="sc">%&gt;%</span> </span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">top_n</span>(<span class="dv">30</span>, bicycle)</span></code></pre></div>
<p>The resulting <code>wight_lines_pct</code> and
<code>wight_lines_30</code> datasets are available in the package. We’ll
use the smaller one for speed. Note: these contain many variables, three
of which (the number of people cycling, driving and walking along the
desire lines from the 2011 Census) are shown below for the Isle of
Wight:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>lwd <span class="ot">=</span> wight_lines_30<span class="sc">$</span>all <span class="sc">/</span> <span class="fu">mean</span>(wight_lines_30<span class="sc">$</span>all) <span class="sc">*</span> <span class="dv">5</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(wight_lines_30[<span class="fu">c</span>(<span class="st">&quot;bicycle&quot;</span>, <span class="st">&quot;car_driver&quot;</span>, <span class="st">&quot;foot&quot;</span>)], <span class="at">lwd =</span> lwd)</span></code></pre></div>
<p>To provide another view of the data, focus on cycling, let’s create a
leaflet map:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>pal <span class="ot">=</span> <span class="fu">colorNumeric</span>(<span class="at">palette =</span> <span class="st">&quot;RdYlBu&quot;</span>, <span class="at">domain =</span> wight_lines_30<span class="sc">$</span>bicycle)</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="fu">leaflet</span>(<span class="at">data =</span> wight_lines_30) <span class="sc">%&gt;%</span> </span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">addTiles</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">addPolylines</span>(<span class="at">weight =</span> lwd,</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>               <span class="at">color =</span> <span class="sc">~</span> <span class="fu">pal</span>(bicycle)) <span class="sc">%&gt;%</span> </span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">addLegend</span>(<span class="at">pal =</span> pal, <span class="at">values =</span> <span class="sc">~</span>bicycle)</span></code></pre></div>
<p>There was a reason for selecting the top 30 lines: it mirrors the
view of the desire lines available from the PCT web application for the
island, available at <a href="https://www.pct.bike/m/?r=isle-of-wight">www.pct.bike/m/?r=isle-of-wight</a>
(note that Straight Lines is selected from the Cycling Flows dropdown
menu in the image below, and by default shows the top 30 flows by number
of bicycle trips).</p>
<div id="getting-census-data" class="section level2">
<h2>Getting Census data</h2>
<p>The previous section showed that data downloaded with
<code>get_pct*()</code> functions <em>get</em> the results generated by
the PCT. However, they do not <em>reproduce</em> the results generated
by the PCT, starting from first principles and publicly available,
official data. Underlying the PCT is origin-destination data from the
2011 Census. The MSOA-level data is open access, so we only provide
access to this dataset. The following command gets the
origin-destination data for the Isle of Wight:</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>wight_od_all <span class="ot">=</span> <span class="fu">get_od</span>(<span class="at">region =</span> <span class="st">&quot;wight&quot;</span>)</span></code></pre></div>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(wight_od_all<span class="sc">$</span>geo_code1 <span class="sc">%in%</span> wight_centroids<span class="sc">$</span>geo_code)</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(wight_od_all<span class="sc">$</span>geo_code2 <span class="sc">%in%</span> wight_centroids<span class="sc">$</span>geo_code)</span></code></pre></div>
<p>Note that all the origin codes match the Isle of Wight centroid
codes, but most of the destination zones do not. This is because many
people on the island work outside the island. <code>get_od()</code> by
default returns only OD pairs in which the commute trips originate from
the <code>area</code> entered.</p>
<p>To make the dataset smaller and simpler, let’s subset it so it only
contains OD pairs in which the origin <em>and</em> destination are in
the island (the resulting <code>wight_od</code> data is provided in the
package):</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>wight_od <span class="ot">=</span> wight_od_all <span class="sc">%&gt;%</span> </span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(geo_code2 <span class="sc">%in%</span> wight_centroids<span class="sc">$</span>geo_code)</span></code></pre></div>
<p>To convert the results to geographic desire lines, we can use the
function <code>od2line()</code> from the <code>stplanr</code>
package:</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>wight_lines <span class="ot">=</span> <span class="fu">od2line</span>(wight_od, wight_centroids)</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="fu">nrow</span>(wight_lines)</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a><span class="fu">sum</span>(wight_lines<span class="sc">$</span>all)</span></code></pre></div>
<p>The previous code chunk downloads and processes 324
origin-destination pairs, representing inter-zonal commuting trips made
by 42,139 people on the island (population: <a href="https://en.wikipedia.org/wiki/Isle_of_Wight">140,000</a>). By
default, the function includes intra-zonal flows, but these can be
omitted as follows (the argument <code>omit_intrazonal</code> in
<code>get_od()</code> does the same thing):</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>wight_lines_census <span class="ot">=</span> wight_lines <span class="sc">%&gt;%</span> </span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(geo_code1 <span class="sc">!=</span> geo_code2)</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a><span class="fu">nrow</span>(wight_lines_census)</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a><span class="fu">sum</span>(wight_lines_census<span class="sc">$</span>all)</span></code></pre></div>
<p>Another OD data processing step developed for the PCT was converting
oneway lines into 2 way lines. This can be done as follows:</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>wight_lines_census1 <span class="ot">=</span> <span class="fu">od_oneway</span>(</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>  wight_lines_census,</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">attrib =</span> <span class="fu">c</span>(<span class="st">&quot;all&quot;</span>, <span class="st">&quot;bicycle&quot;</span>)</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a><span class="fu">nrow</span>(wight_lines_census1) <span class="sc">/</span> <span class="fu">nrow</span>(wight_lines_census)</span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a><span class="fu">sum</span>(wight_lines_census1<span class="sc">$</span>all) <span class="sc">/</span> <span class="fu">sum</span>(wight_lines_census<span class="sc">$</span>all)</span></code></pre></div>
<p>Note that the resulting lines contain 50% of the number of lines, but
the same number of trips: this is because 2 separate lines between the
same zones have been converted into 1 line representing the combined
number of trips in both directions, for each OD pair. This step is not
essential but it has a couple of advantages: it was used in the PCT to
make the routing more computationally efficient (less work computing the
same route twice); and it makes visualising the lines and routes
simpler.</p>
<p>Now that the lines data contains data on 2 way trips between zones,
we can estimate routes (note: the results on the PCT website contain
estimated uptake levels from intrazonal flow) Visually, this involves
converting the straight desire lines shown in the previous map into
routes that can be cycled, as shown in the next code chunk. Note: this
code does not run dynamically, because you need an <a href="https://www.cyclestreets.net/api/apply/">CycleStreets.net API
key</a> for this, and it takes some time:</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>wight_routes_fast <span class="ot">=</span> <span class="fu">route</span>(</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">l =</span> wight_lines_census1,</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">route_fun =</span> cyclestreets<span class="sc">::</span>journey,</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">plan =</span> <span class="st">&quot;fastest&quot;</span>)</span></code></pre></div>
<p>You can download these routes as follows:</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>u <span class="ot">=</span> <span class="st">&quot;https://github.com/ITSLeeds/pct/releases/download/0.5.0/wight_routes_fast.Rds&quot;</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>wight_routes_fast <span class="ot">=</span> <span class="fu">readRDS</span>(<span class="fu">url</span>(u))</span></code></pre></div>
<p>A sample of these is provided in the package as
<code>wight_routes_30_cs</code>, which was generated as follows:</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>wight_lines_census_30 <span class="ot">=</span> wight_lines_census1 <span class="sc">%&gt;%</span> </span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">top_n</span>(<span class="dv">30</span>, bicycle)</span></code></pre></div>
<div class="sourceCode" id="cb20"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>wight_routes_30_cs <span class="ot">=</span> wight_routes_fast <span class="sc">%&gt;%</span> </span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(geo_code1, geo_code2) <span class="sc">%&gt;%</span> </span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">all =</span> <span class="fu">mean</span>(all),</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">bicycle =</span> <span class="fu">mean</span>(bicycle),</span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">av_incline =</span> <span class="fu">weighted.mean</span>(gradient_smooth, <span class="at">w =</span> distances),</span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">length =</span> <span class="fu">sum</span>(distances),</span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">time =</span> <span class="fu">sum</span>(time)</span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span> </span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">top_n</span>(<span class="dv">30</span>, bicycle) </span></code></pre></div>
<p>A simple verification that we have the right desire lines matched to
the routes involves plotting the Euclidean vs Route distance, e.g. as
follows:</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>d <span class="ot">=</span> <span class="fu">as.numeric</span>(<span class="fu">st_length</span>(wight_lines_census_30)) <span class="sc">/</span> <span class="dv">1000</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(d, wight_routes_30_cs<span class="sc">$</span>length <span class="sc">/</span> <span class="dv">1000</span>, <span class="at">xlim =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">10</span>))</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="at">a =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>))</span></code></pre></div>
<p>How well does that match the route distance data downloaded from the
PCT?</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(wight_lines_30<span class="sc">$</span>rf_dist_km, wight_routes_30_cs<span class="sc">$</span>length)</span></code></pre></div>
<p>Almost perfectly for most of the routes. Differences can be explained
by changes in infrastructure since the PCT results were first generated
(these will be updated in the Propensity to Cycle Tool on-line data
later in 2019).</p>
<p>We now have everything needed to estimate cycling uptake for each
desire lines on the Isle of Wight (we’ll do the calculation on the top
30 by current cycling levels).</p>
</div>
<div id="estimate-cycling-uptake" class="section level2">
<h2>Estimate cycling uptake</h2>
<p>Functions named with <code>uptake_*()</code> estimate cycling
uptake:</p>
<ul>
<li><code>uptake_pct_godutch()</code>: generates the “GoDutch” scenario
level of cycling based on a particular route’s hilliness percentage and
length.</li>
<li><code>uptake_pct_govtarget()</code>: generates the UK government
target again based on the hilliness and length parameters.</li>
</ul>
<p>We will estimate cycling potential with
<code>uptake_pct_godutch()</code>, using the <code>length</code> and
<code>av_incline</code> from the <code>wight_routes_30_cs</code>
object.</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>pcycle_govtarget <span class="ot">=</span> <span class="fu">uptake_pct_govtarget</span>(</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">distance =</span> wight_routes_30_cs<span class="sc">$</span>length,</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">gradient =</span> wight_routes_30_cs<span class="sc">$</span>av_incline <span class="sc">*</span> <span class="dv">100</span></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
<p>In terms of cycling uptake, the results are shown below:</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>wight_routes_30_cs<span class="sc">$</span>govtarget <span class="ot">=</span> wight_lines_census_30<span class="sc">$</span>bicycle <span class="sc">+</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>  pcycle_govtarget <span class="sc">*</span> wight_lines_census_30<span class="sc">$</span>all</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>wight_routes_30_cs<span class="sc">$</span>govtarget_pct <span class="ot">=</span> wight_lines_30<span class="sc">$</span>govtarget_slc</span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(wight_routes_30_cs) <span class="sc">+</span></span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(length, govtarget), <span class="at">colour =</span> <span class="st">&quot;red&quot;</span>) <span class="sc">+</span></span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(length, govtarget_pct), <span class="at">colour =</span> <span class="st">&quot;blue&quot;</span>) </span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a><span class="fu">cor</span>(wight_routes_30_cs<span class="sc">$</span>govtarget, wight_routes_30_cs<span class="sc">$</span>govtarget_pct)</span></code></pre></div>
<p>The final computational stage is also one of the most important from
a policy perspective: estimating cycling potential down to the street
level, to help prioritise investment where it is most needed. This work
is done by the <code>overline2()</code> function, as follows:</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>wight_routes_30_ls <span class="ot">=</span> sf<span class="sc">::</span><span class="fu">st_cast</span>(wight_routes_30_cs, <span class="st">&quot;LINESTRING&quot;</span>)</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>rnet <span class="ot">=</span> <span class="fu">overline</span>(wight_routes_30_ls, <span class="st">&quot;govtarget&quot;</span>)</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(rnet)</span></code></pre></div>
<p>Running the same function for all routes in
<code>wight_routes_fast</code>, generates the packaged data object
<code>wight_rnet</code>, which was created as follows:</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>wight_routes_fast_gt <span class="ot">=</span> wight_routes_fast <span class="sc">%&gt;%</span> </span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(geo_code1, geo_code2) <span class="sc">%&gt;%</span> </span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">govtarget =</span> <span class="fu">uptake_pct_govtarget</span>(<span class="fu">sum</span>(distances), <span class="fu">mean</span>(gradient_smooth)) <span class="sc">*</span></span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>      (<span class="fu">sum</span>(all) <span class="sc">+</span> <span class="fu">sum</span>(bicycle))</span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a>wight_routes_fast_gt <span class="ot">=</span> sf<span class="sc">::</span><span class="fu">st_cast</span>(wight_routes_fast_gt, <span class="st">&quot;LINESTRING&quot;</span>)</span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a>wight_rnet <span class="ot">=</span> <span class="fu">overline</span>(wight_routes_fast_gt, <span class="st">&quot;govtarget&quot;</span>)</span></code></pre></div>
<div class="sourceCode" id="cb27"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>pal <span class="ot">=</span> <span class="fu">colorNumeric</span>(<span class="at">palette =</span> <span class="st">&quot;RdYlBu&quot;</span>, <span class="at">domain =</span> wight_rnet<span class="sc">$</span>govtarget)</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a><span class="fu">leaflet</span>(<span class="at">data =</span> wight_rnet) <span class="sc">%&gt;%</span> </span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">addTiles</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">addPolylines</span>(<span class="at">color =</span> <span class="sc">~</span> <span class="fu">pal</span>(govtarget)) <span class="sc">%&gt;%</span> </span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">addLegend</span>(<span class="at">pal =</span> pal, <span class="at">values =</span> <span class="sc">~</span>govtarget)</span></code></pre></div>
</div>
</div>
<div id="references" class="section level1 unnumbered">
<h1 class="unnumbered">References</h1>
<div id="refs" class="references csl-bib-body" line-spacing="2">
<div id="ref-department_for_transport_local_2017" class="csl-entry">
<div class="csl-left-margin">1. </div><div class="csl-right-inline">Department for Transport. <em><a href="https://assets.publishing.service.gov.uk/government/uploads/system/uploads/attachment_data/file/607016/cycling-walking-infrastructure-technical-guidance.pdf">Local
<span>Cycling</span> and <span>Walking</span>
<span>Infrastructure</span> <span>Plans</span></a></em>. (Department for
Transport, 2017).</div>
</div>
<div id="ref-lovelace_propensity_2017" class="csl-entry">
<div class="csl-left-margin">2. </div><div class="csl-right-inline">Lovelace, R. <em>et al.</em> <a href="https://doi.org/10.5198/jtlu.2016.862">The <span>Propensity</span>
to <span>Cycle</span> <span>Tool</span>: <span>An</span> open source
online system for sustainable transport planning</a>. <em>Journal of
Transport and Land Use</em> <strong>10,</strong> (2017).</div>
</div>
<div id="ref-goodman_scenarios_2019" class="csl-entry">
<div class="csl-left-margin">3. </div><div class="csl-right-inline">Goodman, A. <em>et al.</em> <a href="https://doi.org/10.1016/j.jth.2019.01.008">Scenarios of cycling to
school in <span>England</span>, and associated health and carbon
impacts: <span>Application</span> of the <span>‘<span>Propensity</span>
to <span>Cycle</span> <span>Tool</span>’</span></a>. <em>Journal of
Transport &amp; Health</em> <strong>12,</strong> 263–278 (2019).</div>
</div>
<div id="ref-department_for_transport_national_2016" class="csl-entry">
<div class="csl-left-margin">4. </div><div class="csl-right-inline">Department for Transport. <em><a href="https://www.gov.uk/government/publications/national-propensity-to-cycle-first-phase-development-study">National
<span>Propensity</span> to <span>Cycle</span> <span>Tool</span>
<span>Project</span>: Full report with annexes</a></em>. (Department for
Transport, 2016).</div>
</div>
</div>
</div>



<!-- code folding -->


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
